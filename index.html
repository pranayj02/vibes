<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy of Architecture - Attendance Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', Arial, sans-serif;
            margin: 0;
            background: #f6f7fb;
            color: #222;
        }
        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            text-align: center;
            padding: 2em 1em;
        }
        .hero h1 {
            font-size: 2.5em;
            margin-bottom: 0.2em;
        }
        .hero p {
            font-size: 1.2em;
            margin-bottom: 2em;
            font-weight: 400;
        }
        .google-btn {
            background: #fff;
            color: #222;
            border: none;
            border-radius: 8px;
            padding: 0.8em 2em;
            font-size: 1.1em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.7em;
            transition: background 0.2s;
        }
        .google-btn:hover {
            background: #f1f1f1;
        }
        .user-bar {
            display: flex;
            align-items: center;
            gap: 1em;
            justify-content: flex-end;
            padding: 1em;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .user-bar img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .logout-btn {
            background: #e53e3e;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.5em 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .logout-btn:hover {
            background: #c53030;
        }
        .container {
            max-width: 700px;
            margin: 2em auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.07);
            padding: 2em 1em 2em 1em;
        }
        .subjects {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin-bottom: 2em;
            justify-content: center;
        }
        .subject {
            background: #f6f7fb;
            border-radius: 8px;
            padding: 1em 1.5em;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.2s, background 0.2s;
        }
        .subject.selected {
            border: 2px solid #764ba2;
            background: #e9e6f7;
        }
        .calendar-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1em;
            margin-bottom: 1em;
        }
        .calendar-controls button {
            background: #764ba2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.4em 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .calendar-controls button:hover {
            background: #667eea;
        }
        .calendar {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2em;
        }
        .calendar th, .calendar td {
            width: 14.2%;
            height: 48px;
            text-align: center;
            border-radius: 6px;
            font-size: 1em;
        }
        .calendar th {
            color: #764ba2;
            font-weight: 700;
            background: #f6f7fb;
        }
        .calendar td {
            background: #f6f7fb;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        .calendar td.attended {
            background: #a3e635;
            color: #222;
            font-weight: 700;
        }
        .calendar td.missed {
            background: #f87171;
            color: #fff;
            font-weight: 700;
        }
        .calendar td.today {
            border: 2px solid #764ba2;
        }
        .save-btn {
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.8em 2em;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 1.5em;
            transition: background 0.2s;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .save-btn:disabled {
            background: #b3b3b3;
            cursor: not-allowed;
        }
        .feedback {
            text-align: center;
            margin-bottom: 1em;
            color: #764ba2;
            font-weight: 600;
            min-height: 1.5em;
        }
        @media (max-width: 600px) {
            .container {
                padding: 1em 0.2em;
            }
            .subjects {
                flex-direction: column;
                gap: 0.5em;
            }
            .calendar th, .calendar td {
                font-size: 0.9em;
                height: 36px;
            }
            .save-btn {
                font-size: 1em;
                padding: 0.7em 1.2em;
            }
        }
    </style>
</head>
<body>
    <div id="hero" class="hero">
        <h1>ðŸŽ“ Academy of Architecture</h1>
        <p>Smart Attendance Planning for Academic Excellence</p>
        <button id="google-signin" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" width="24" height="24">
            Sign in with Google
        </button>
        <div id="login-error" style="color:#f87171; margin-top:1em;"></div>
    </div>
    <div id="app" style="display:none;">
        <div class="user-bar">
            <img id="user-photo" src="" alt="User photo" style="display:none;">
            <span id="user-name"></span>
            <button id="logout" class="logout-btn">Logout</button>
        </div>
        <div class="container">
            <div class="feedback" id="feedback"></div>
            <div class="subjects" id="subjects"></div>
            <div class="calendar-controls">
                <button id="prev-month">&#8592; Prev</button>
                <span id="month-label"></span>
                <button id="next-month">Next &#8594;</button>
            </div>
            <table class="calendar" id="calendar"></table>
            <button class="save-btn" id="save-btn">Save Attendance</button>
        </div>
    </div>
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAivmSS-l5RZ-pK5pQ1QnKbGHveLte3pHs",
            authDomain: "attendance-a7ada.firebaseapp.com",
            projectId: "attendance-a7ada",
            storageBucket: "attendance-a7ada.appspot.com",
            messagingSenderId: "485257899915",
            appId: "1:485257899915:web:ad5ff35cc6da9e8e39498e"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Default subjects
        const defaultSubjects = [
            {
                id: 1,
                name: "Design Dissertation - 1",
                target: 75,
                startDate: '2025-06-10',
                examDate: '2025-09-16',
                classDays: [1], // Monday
                timeSlot: "7:30 AM - 10:30 AM",
            },
            {
                id: 2,
                name: "Professional Practice - 2",
                target: 75,
                startDate: '2025-06-10',
                examDate: '2025-09-16',
                classDays: [2], // Tuesday
                timeSlot: "10:30 AM - 12:30 PM",
            },
            {
                id: 3,
                name: "Urban Design - 2",
                target: 75,
                startDate: '2025-06-10',
                examDate: '2025-09-16',
                classDays: [3], // Wednesday
                timeSlot: "1:30 PM - 3:30 PM",
            },
            {
                id: 4,
                name: "Elective - 2",
                target: 75,
                startDate: '2025-06-10',
                examDate: '2025-09-16',
                classDays: [4], // Thursday
                timeSlot: "3:30 PM - 5:30 PM",
            }
        ];

        // State
        let subjects = [];
        let selectedSubject = null;
        let attendance = {}; // { subjectId: { 'YYYY-MM-DD': true/false } }
        let currentDate = new Date();

        // DOM
        const hero = document.getElementById('hero');
        const appDiv = document.getElementById('app');
        const googleSigninBtn = document.getElementById('google-signin');
        const loginError = document.getElementById('login-error');
        const userPhoto = document.getElementById('user-photo');
        const userName = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout');
        const subjectsDiv = document.getElementById('subjects');
        const calendar = document.getElementById('calendar');
        const monthLabel = document.getElementById('month-label');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const saveBtn = document.getElementById('save-btn');
        const feedback = document.getElementById('feedback');

        // --- Firebase Auth ---
        googleSigninBtn.onclick = async () => {
            loginError.textContent = '';
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (err) {
                loginError.textContent = err.message;
            }
        };

        logoutBtn.onclick = async () => {
            await signOut(auth);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                hero.style.display = 'none';
                appDiv.style.display = '';
                userPhoto.src = user.photoURL;
                userPhoto.style.display = 'inline-block';
                userName.textContent = user.displayName;
                await loadAttendance(user.uid);
                renderSubjects();
                renderCalendar();
            } else {
                appDiv.style.display = 'none';
                hero.style.display = '';
                userPhoto.style.display = 'none';
                userName.textContent = '';
                feedback.textContent = '';
                subjects = [];
                selectedSubject = null;
                attendance = {};
            }
        });

        // --- Attendance Data ---
        async function loadAttendance(uid) {
            feedback.textContent = 'Loading attendance...';
            try {
                const docRef = doc(db, 'attendance', uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    subjects = data.subjects || JSON.parse(JSON.stringify(defaultSubjects));
                    selectedSubject = data.selectedSubject || subjects[0].id;
                    attendance = data.attendance || {};
                } else {
                    subjects = JSON.parse(JSON.stringify(defaultSubjects));
                    selectedSubject = subjects[0].id;
                    attendance = {};
                }
                feedback.textContent = '';
            } catch (err) {
                feedback.textContent = 'Failed to load attendance.';
            }
        }

        async function saveAttendance(uid) {
            feedback.textContent = 'Saving...';
            saveBtn.disabled = true;
            try {
                await setDoc(doc(db, 'attendance', uid), {
                    subjects,
                    selectedSubject,
                    attendance
                });
                feedback.textContent = 'Attendance saved!';
                setTimeout(() => feedback.textContent = '', 2000);
            } catch (err) {
                feedback.textContent = 'Failed to save attendance.';
            }
            saveBtn.disabled = false;
        }

        // --- UI Rendering ---
        function renderSubjects() {
            subjectsDiv.innerHTML = '';
            subjects.forEach(subj => {
                const btn = document.createElement('div');
                btn.className = 'subject' + (subj.id === selectedSubject ? ' selected' : '');
                btn.textContent = subj.name;
                btn.onclick = () => {
                    selectedSubject = subj.id;
                    renderSubjects();
                    renderCalendar();
                };
                subjectsDiv.appendChild(btn);
            });
        }

        function renderCalendar() {
            if (!selectedSubject) return;
            const subj = subjects.find(s => s.id === selectedSubject);
            if (!subj) return;
            // Get month/year
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthLabel.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            // First day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            // Build calendar grid
            let html = '<tr>';
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => html += `<th>${d}</th>`);
            html += '</tr><tr>';
            let day = 1;
            let started = false;
            for (let i = 0; i < 42; i++) {
                const date = new Date(year, month, i - firstDay.getDay() + 1);
                if (i < firstDay.getDay() || date > lastDay) {
                    html += '<td></td>';
                } else {
                    const dateStr = date.toISOString().slice(0,10);
                    let cellClass = '';
                    if (attendance[subj.id] && attendance[subj.id][dateStr] === true) cellClass = 'attended';
                    if (attendance[subj.id] && attendance[subj.id][dateStr] === false) cellClass = 'missed';
                    if (dateStr === (new Date()).toISOString().slice(0,10)) cellClass += ' today';
                    html += `<td class="${cellClass}" data-date="${dateStr}">${date.getDate()}</td>`;
                }
                if ((i+1)%7 === 0 && i < 41) html += '</tr><tr>';
            }
            html += '</tr>';
            calendar.innerHTML = html;
            // Add click handlers
            Array.from(calendar.querySelectorAll('td[data-date]')).forEach(td => {
                td.onclick = () => {
                    if (!attendance[subj.id]) attendance[subj.id] = {};
                    const dateStr = td.getAttribute('data-date');
                    if (attendance[subj.id][dateStr] === true) attendance[subj.id][dateStr] = false;
                    else if (attendance[subj.id][dateStr] === false) delete attendance[subj.id][dateStr];
                    else attendance[subj.id][dateStr] = true;
                    renderCalendar();
                };
            });
        }

        prevMonthBtn.onclick = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        };
        nextMonthBtn.onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };

        saveBtn.onclick = async () => {
            const user = auth.currentUser;
            if (!user) return;
            await saveAttendance(user.uid);
        };
    </script>
</body>
</html>
